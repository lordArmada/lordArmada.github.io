<?php
// Enable error reporting
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

// Include database configuration
require_once "./config.php";

// Start session
session_start();

// Check if deposit ID is provided
if (!isset($_GET['id'])) {
    die("No deposit ID provided.");
}

$deposit_id = intval($_GET['id']); // Sanitize the ID

// Begin transaction
mysqli_begin_transaction($link);

try {
    // Fetch the deposit details
    $query = "SELECT user_id, amount, status FROM deposits WHERE id = ?";
    $stmt = mysqli_prepare($link, $query);
    if (!$stmt) {
        throw new Exception("Failed to prepare statement: " . mysqli_error($link));
    }

    mysqli_stmt_bind_param($stmt, 'i', $deposit_id);
    mysqli_stmt_execute($stmt);
    mysqli_stmt_bind_result($stmt, $user_id, $amount, $status);

    // Ensure a record was found and check the current status
    if (!mysqli_stmt_fetch($stmt)) {
        throw new Exception("No deposit found with the given ID.");
    }
    mysqli_stmt_close($stmt);

    if ($status !== 'pending') {
        throw new Exception("Only 'pending' deposits can be approved.");
    }

    // Update the deposit status to 'confirmed'
    $update_query = "UPDATE deposits SET status = 'confirmed' WHERE id = ?";
    $stmt = mysqli_prepare($link, $update_query);
    if (!$stmt) {
        throw new Exception("Failed to prepare statement: " . mysqli_error($link));
    }

    mysqli_stmt_bind_param($stmt, 'i', $deposit_id);
    if (!mysqli_stmt_execute($stmt)) {
        throw new Exception("Failed to update deposit status: " . mysqli_error($link));
    }
    mysqli_stmt_close($stmt);

    // Update the user's balance
    $balance_update_query = "UPDATE users SET balance = balance + ? WHERE id = ?";
    $stmt = mysqli_prepare($link, $balance_update_query);
    if (!$stmt) {
        throw new Exception("Failed to prepare statement: " . mysqli_error($link));
    }

    mysqli_stmt_bind_param($stmt, 'di', $amount, $user_id);
    if (!mysqli_stmt_execute($stmt)) {
        throw new Exception("Failed to update user balance: " . mysqli_error($link));
    }

    // Ensure the balance was updated
    if (mysqli_affected_rows($link) === 0) {
        throw new Exception("User balance not updated. User ID: $user_id, Amount: $amount");
    }
    mysqli_stmt_close($stmt);

    // Fetch the new balance
    $balance_query = "SELECT balance FROM users WHERE id = ?";
    $stmt = mysqli_prepare($link, $balance_query);
    if (!$stmt) {
        throw new Exception("Failed to prepare statement: " . mysqli_error($link));
    }

    mysqli_stmt_bind_param($stmt, 'i', $user_id);
    mysqli_stmt_execute($stmt);
    mysqli_stmt_bind_result($stmt, $new_balance);
    mysqli_stmt_fetch($stmt);
    mysqli_stmt_close($stmt);

    // Update the session balance
    $_SESSION["balance"] = $new_balance;

    // Commit the transaction
    mysqli_commit($link);

    // Success message
    // Optional redirect
    // header("Location: ./admin.php?message=Deposit approved successfully");
    // exit();

} catch (Exception $e) {
    // Rollback the transaction on error
    mysqli_rollback($link);

    // Display error message
    echo "Error: " . $e->getMessage();
    exit();
}

// Close the database connection
mysqli_close($link);
?>
