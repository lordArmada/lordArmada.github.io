<?php
// Display all errors
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

session_start(); // Start session for session variables

require './config.php'; // Database connection file

if (isset($_GET['id'])) {
    $deposit_id = intval($_GET['id']);

    // Begin a transaction
    mysqli_begin_transaction($link);

    try {
        // Step 1: Fetch the deposit amount and user_id
        $query = "SELECT user_id, amount FROM withdrawals WHERE id = ?";
        if (!$stmt = mysqli_prepare($link, $query)) {
            throw new Exception("Prepare statement failed: " . mysqli_error($link));
        }
        mysqli_stmt_bind_param($stmt, 'i', $deposit_id);
        mysqli_stmt_execute($stmt);
        mysqli_stmt_bind_result($stmt, $user_id, $amount);
        mysqli_stmt_fetch($stmt);

        // Check if values are fetched
        if ($amount === null || $user_id === null) {
            throw new Exception("No amount or user ID found for this withdrawal.");
        }
        mysqli_stmt_close($stmt);

        // Step 2: Update withdrawal status to 'completed'
        $update_query = "UPDATE withdrawals SET status = 'processed' WHERE id = ?";
        if (!$stmt = mysqli_prepare($link, $update_query)) {
            throw new Exception("Prepare statement failed: " . mysqli_error($link));
        }
        mysqli_stmt_bind_param($stmt, 'i', $deposit_id);
        if (!mysqli_stmt_execute($stmt)) {
            throw new Exception("Error updating withdrawal status: " . mysqli_error($link));
        }
        mysqli_stmt_close($stmt);

        // Step 3: Update the user's balance
        $balance_update_query = "UPDATE users SET balance = balance - ? WHERE id = ?";
        if (!$stmt = mysqli_prepare($link, $balance_update_query)) {
            throw new Exception("Prepare statement failed: " . mysqli_error($link));
        }
        mysqli_stmt_bind_param($stmt, 'di', $amount, $user_id);
        if (!mysqli_stmt_execute($stmt)) {
            throw new Exception("Error updating user balance: " . mysqli_error($link));
        }

        // Ensure the balance update was successful
        if (mysqli_affected_rows($link) === 0) {
            throw new Exception("User balance not updated. User ID: $user_id, Amount: $amount");
        }
        mysqli_stmt_close($stmt);

        // Step 4: Fetch the new balance
        $balance_query = "SELECT balance FROM users WHERE id = ?";
        if (!$stmt = mysqli_prepare($link, $balance_query)) {
            throw new Exception("Prepare statement failed: " . mysqli_error($link));
        }
        mysqli_stmt_bind_param($stmt, 'i', $user_id);
        mysqli_stmt_execute($stmt);
        mysqli_stmt_bind_result($stmt, $new_balance);
        mysqli_stmt_fetch($stmt);
        mysqli_stmt_close($stmt);

        // Update session with the new balance
        $_SESSION["balance"] = $new_balance;

        // Commit the transaction
        mysqli_commit($link);
    } catch (Exception $e) {
        // Rollback the transaction in case of error
        mysqli_rollback($link);
        // Output error message for debugging
        echo "Error: " . $e->getMessage();
    }
}

// Close the database connection
mysqli_close($link);
